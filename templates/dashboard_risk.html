{% extends "base.html" %}

{% block title %}Panel de Riesgo Académico{% endblock %}

{% block content %}
<style>
    /* Variables de colores exactos de la imagen */
    :root {
        --up-red: #c62828;       /* Rojo Oscuro Header */
        --up-red-light: #d32f2f; /* Rojo Botón */
        --bg-gray: #f8f9fa;      /* Fondo General */
        --card-bg: #ffffff;
        --border-color: #e0e0e0;
        
        /* Colores de Estado */
        --risk-high-bg: #ffebee;
        --risk-high-text: #c62828;
        --risk-high-icon: #ef5350;
        
        --risk-med-bg: #fff8e1;
        --risk-med-text: #f57f17;
        --risk-med-icon: #ffca28;
        
        --risk-low-bg: #e8f5e9;
        --risk-low-text: #2e7d32;
        --risk-low-icon: #66bb6a;
        
        --blue-accent: #e3f2fd;
        --blue-icon: #42a5f5;
    }

    body {
        background-color: var(--bg-gray);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Contenedor Principal */
    .dashboard-wrapper {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        display: flex;
        flex-direction: column; /* Asegura que todo vaya de arriba a abajo */
        gap: 20px;
    }

    /* --- 1. HEADER ROJO (Ancho Completo) --- */
    .risk-header {
        background-color: var(--up-red);
        color: white;
        padding: 25px 30px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .header-titles h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
        color: white;
    }

    .header-titles p {
        margin: 5px 0 0 0;
        font-size: 13px;
        opacity: 0.8;
        color: white;
    }

    .header-objective {
        background-color: rgba(0, 0, 0, 0.2); /* Fondo oscuro semitransparente */
        padding: 15px;
        border-radius: 6px;
        display: flex;
        gap: 15px;
        max-width: 450px;
        align-items: flex-start;
    }

    .info-icon {
        font-size: 24px;
        font-weight: bold;
    }

    /* --- 2. TARJETAS DE ESTADÍSTICAS (Fila Superior) --- */
    .kpi-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr); /* 4 Columnas iguales */
        gap: 20px;
    }

    .kpi-card {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 5px solid transparent; /* Borde izquierdo de color */
    }

    /* Colores específicos KPI */
    .kpi-card.blue { border-left-color: #2196f3; }
    .kpi-card.red { border-left-color: var(--risk-high-text); }
    .kpi-card.yellow { border-left-color: #ffb300; }
    .kpi-card.green { border-left-color: var(--risk-low-text); }

    .kpi-content h3 {
        margin: 0;
        font-size: 14px;
        color: #666;
        font-weight: 600;
    }

    .kpi-content .number {
        font-size: 32px;
        font-weight: 700;
        margin-top: 5px;
        line-height: 1;
    }

    .kpi-card.red .number { color: var(--risk-high-text); }
    .kpi-card.yellow .number { color: #f57f17; }
    .kpi-card.green .number { color: var(--risk-low-text); }

    .kpi-icon {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* Iconos circulares */
    .kpi-icon.blue { background: var(--blue-accent); color: var(--blue-icon); }
    .kpi-icon.red { background: var(--risk-high-bg); color: var(--risk-high-icon); }
    .kpi-icon.yellow { background: var(--risk-med-bg); color: var(--risk-med-icon); }
    .kpi-icon.green { background: var(--risk-low-bg); color: var(--risk-low-icon); }


    /* --- 3. DISEÑO DIVIDIDO (Filtros Izq | Listas Der) --- */
    .split-content {
        display: grid;
        grid-template-columns: 280px 1fr; /* Columna fija izq, resto der */
        gap: 20px;
        align-items: start;
    }

    /* Barra Lateral de Filtros */
    .filters-sidebar {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .filters-sidebar h3 {
        margin-top: 0;
        font-size: 18px;
        color: #333;
        margin-bottom: 20px;
    }

    .filter-group {
        margin-bottom: 15px;
    }

    .filter-group label {
        display: block;
        font-size: 13px;
        color: #666;
        margin-bottom: 5px;
        font-weight: 600;
    }

    .filter-group select, .filter-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box; /* Importante para que no se salga */
    }

    .filter-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 20px;
    }

    .btn-apply {
        background: var(--up-red-light);
        color: white;
        border: none;
        padding: 10px;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-clear {
        background: #e0e0e0;
        color: #333;
        border: none;
        padding: 10px;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
    }

    /* Listas de Riesgo (Derecha) */
    .risk-lists-wrapper {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .risk-section-card {
        background: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border-left: 5px solid #ccc;
        min-height: 180px; /* Altura mínima para parecerse a la imagen */
    }

    .risk-section-card.high { border-left-color: var(--risk-high-text); }
    .risk-section-card.medium { border-left-color: #ffb300; }
    .risk-section-card.low { border-left-color: var(--risk-low-text); }

    .section-header {
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        font-size: 16px;
        color: #333;
    }

    .section-header svg { width: 20px; height: 20px; }
    .section-header.high svg { color: var(--risk-high-text); }
    .section-header.medium svg { color: #ffb300; }
    .section-header.low svg { color: var(--risk-low-text); }

    .empty-message {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100px;
        color: #999;
        font-size: 14px;
    }

    /* Estilo de lista de estudiantes si hay datos */
    .student-row {
        padding: 12px 20px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .student-row:hover { background-color: #f9f9f9; }
    .student-info strong { display: block; color: #333; }
    .student-info span { font-size: 12px; color: #777; }
    .btn-link { color: #2196f3; text-decoration: none; font-size: 13px; font-weight: 600; }

    /* Responsivo */
    @media (max-width: 1024px) {
        .split-content { grid-template-columns: 1fr; }
        .kpi-row { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 600px) {
        .kpi-row { grid-template-columns: 1fr; }
        .header-objective { display: none; } /* Ocultar objetivo en móviles */
    }
</style>

<div class="dashboard-wrapper">
    
    <div class="risk-header">
        <div class="header-titles">
            <h2>Panel de Riesgo Académico</h2>
            <p>Última actualización: {{ now().strftime("%d de %B de %Y, %I:%M %p") }}</p>
        </div>
        <div class="header-objective">
            <div class="info-icon">ⓘ</div>
            <div>
                <strong style="display:block; margin-bottom:4px; font-size:14px;">Objetivo del panel</strong>
                <span style="font-size:12px; line-height: 1.4; display:block;">Identificar y visualizar estudiantes en diferentes niveles de riesgo académico para facilitar la intervención oportuna.</span>
            </div>
        </div>
    </div>

    <div class="kpi-row">
        <div class="kpi-card blue">
            <div class="kpi-content">
                <h3>Estudiantes</h3>
                <div class="number">{{ estadisticas.total_estudiantes }}</div>
            </div>
            <div class="kpi-icon blue">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
            </div>
        </div>

        <div class="kpi-card red">
            <div class="kpi-content">
                <h3>Alto riesgo</h3>
                <div class="number">{{ estadisticas.alto_riesgo }}</div>
            </div>
            <div class="kpi-icon red">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
            </div>
        </div>

        <div class="kpi-card yellow">
            <div class="kpi-content">
                <h3>Medio riesgo</h3>
                <div class="number">{{ estadisticas.medio_riesgo }}</div>
            </div>
            <div class="kpi-icon yellow">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            </div>
        </div>

        <div class="kpi-card green">
            <div class="kpi-content">
                <h3>Bajo riesgo</h3>
                <div class="number">{{ estadisticas.bajo_riesgo }}</div>
            </div>
            <div class="kpi-icon green">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </div>
        </div>
    </div>

    <div class="split-content">
        
        <aside class="filters-sidebar">
            <h3>Filtros</h3>
            <form method="GET" action="{{ url_for('dashboard_risk') }}">
                <div class="filter-group">
                    <label>Nivel de Riesgo:</label>
                    <select name="nivel_riesgo">
                        <option value="">– Todos –</option>
                        <option value="alto" {% if filtros.nivel_riesgo == 'alto' %}selected{% endif %}>Alto</option>
                        <option value="medio" {% if filtros.nivel_riesgo == 'medio' %}selected{% endif %}>Medio</option>
                        <option value="bajo" {% if filtros.nivel_riesgo == 'bajo' %}selected{% endif %}>Bajo</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Carrera:</label>
                    <select name="carrera">
                        <option value="">– Todas –</option>
                        {% for c in carreras %}
                        <option value="{{ c }}" {% if filtros.carrera == c %}selected{% endif %}>{{ c }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label>Cuatrimestre:</label>
                    <select name="cuatrimestre">
                        <option value="">– Todos –</option>
                        {% for ct in cuatrimestres %}
                        <option value="{{ ct }}" {% if filtros.cuatrimestre == ct %}selected{% endif %}>{{ ct }}°</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label>Buscar (Nombre/Matrícula):</label>
                    <input type="text" name="busqueda" placeholder="Ingrese nombre o matrícula" value="{{ filtros.busqueda }}">
                </div>

                <div class="filter-actions">
                    <button type="submit" class="btn-apply">Aplicar</button>
                    <a href="{{ url_for('dashboard_risk') }}" class="btn-clear">Limpiar</a>
                </div>
            </form>
        </aside>

        <div class="risk-lists-wrapper">
            
            <div class="risk-section-card high">
                <div class="section-header high">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    Sección de estudiantes alto riesgo
                </div>
                {% if alto_riesgo %}
                    {% for est in alto_riesgo %}
                    <div class="student-row">
                        <div class="student-info">
                            <strong>{{ est.nombre }} {{ est.apellido_p }}</strong>
                            <span>{{ est.matricula }} | {{ est.carrera }} ({{ est.cuatrimestre }}°)</span>
                        </div>
                        <a href="{{ url_for('student_history', student_id=est.id) }}" class="btn-link">Ver Historial</a>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-message">No hay estudiantes que mostrar en esta sección.</div>
                {% endif %}
            </div>

            <div class="risk-section-card medium">
                <div class="section-header medium">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    Sección de estudiantes medio riesgo
                </div>
                {% if medio_riesgo %}
                    {% for est in medio_riesgo %}
                    <div class="student-row">
                        <div class="student-info">
                            <strong>{{ est.nombre }} {{ est.apellido_p }}</strong>
                            <span>{{ est.matricula }} | {{ est.carrera }} ({{ est.cuatrimestre }}°)</span>
                        </div>
                        <a href="{{ url_for('student_history', student_id=est.id) }}" class="btn-link">Ver Historial</a>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-message">No hay estudiantes que mostrar en esta sección.</div>
                {% endif %}
            </div>

            <div class="risk-section-card low">
                <div class="section-header low">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    Sección de estudiantes bajo riesgo
                </div>
                {% if bajo_riesgo %}
                    {% for est in bajo_riesgo %}
                    <div class="student-row">
                        <div class="student-info">
                            <strong>{{ est.nombre }} {{ est.apellido_p }}</strong>
                            <span>{{ est.matricula }} | {{ est.carrera }} ({{ est.cuatrimestre }}°)</span>
                        </div>
                        <a href="{{ url_for('student_history', student_id=est.id) }}" class="btn-link">Ver Historial</a>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-message">No hay estudiantes que mostrar en esta sección.</div>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<canvas id="chartRiesgo" style="display:none;"></canvas>

{% endblock %}