{% extends "base.html" %}
{% block title %}Perfil de {{ estudiante['nombre'] }}{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- Informaci√≥n del Estudiante -->
    <div class="student-card">
        <div class="student-header">
            <div class="student-avatar">üë§</div>
            <div class="student-info">
                <h2>{{ estudiante['nombre'] }} {{ estudiante['apellido_p'] }} {{ estudiante['apellido_m'] }}</h2>
                <p><strong>Matr√≠cula:</strong> {{ estudiante['matricula'] }}</p>
                <p><strong>Carrera:</strong> {{ estudiante['carrera'] or 'N/A' }}</p>
                <p><strong>Cuatrimestre:</strong> {{ estudiante['cuatrimestre_actual'] }}¬∞</p>
            </div>
        </div>
        <div class="student-actions">
            <a href="{{ url_for('editar_estudiante', id=estudiante['id']) }}" class="btn-edit">‚úèÔ∏è Editar</a>
            <a href="{{ url_for('report_student', student_id=estudiante['id']) }}" class="btn-pdf">üìÑ Descargar PDF</a>
            <a href="{{ url_for('lista_estudiantes') }}" class="btn-back">‚Üê Volver</a>
        </div>
    </div>

    <!-- Historial Acad√©mico -->
    {% if analisis %}
    <div class="stats-section">
        <h3>üìä Estad√≠sticas Generales</h3>
        <div class="stats-grid">
            <div class="stat-box">
                <span class="stat-value">{{ analisis.total_tutorias }}</span>
                <span class="stat-label">Total de Tutor√≠as</span>
            </div>
            <div class="stat-box">
                <span class="stat-value">{{ analisis.cuatrimestres_registrados }}</span>
                <span class="stat-label">Cuatrimestres con Registro</span>
            </div>
            <div class="stat-box">
                <span class="stat-value">{{ analisis.reincidencias|length }}</span>
                <span class="stat-label">Reincidencias Detectadas</span>
            </div>
        </div>
    </div>

    <!-- Alertas -->
    {% if analisis.alertas %}
    <div class="alerts-section">
        <h3>‚ö†Ô∏è Alertas</h3>
        {% for alerta in analisis.alertas %}
        <div class="alert" style="border-left-color: {{ alerta.color }};">
            <strong>{{ alerta.nivel|upper }}:</strong> {{ alerta.mensaje }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Gr√°ficos -->
    <div class="charts-section">
        <div class="chart-container">
            <h3>Frecuencia de Tutor√≠as por Cuatrimestre</h3>
            <canvas id="chartFrecuencia"></canvas>
        </div>
        <div class="chart-container">
            <h3>Motivos Principales</h3>
            <canvas id="chartMotivos"></canvas>
        </div>
    </div>

    <!-- Historial Detallado -->
    <div class="history-section">
        <h3>üìö Historial de Tutor√≠as</h3>
        {% for cuatri, tuts in analisis.por_cuatrimestre.items() %}
        <div class="cuatrimestre-block">
            <h4>Cuatrimestre {{ cuatri }}¬∞ ({{ tuts|length }} tutor√≠as)</h4>
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Motivo</th>
                        <th>Descripci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tut in tuts %}
                    <tr>
                        <td>{{ tut.fecha }}</td>
                        <td>{{ tut.motivo }}</td>
                        <td>{{ tut.descripcion or 'N/A' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="no-data">
        <p>Este estudiante no tiene tutor√≠as registradas a√∫n.</p>
    </div>
    {% endif %}
</div>

{% if analisis %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Gr√°fico de Frecuencia
const ctxFrecuencia = document.getElementById('chartFrecuencia').getContext('2d');
new Chart(ctxFrecuencia, {
    type: 'line',
    data: {
        labels: {{ datos_frecuencia.labels|tojson }},
        datasets: [{
            label: 'N√∫mero de Tutor√≠as',
            data: {{ datos_frecuencia.data|tojson }},
            borderColor: '#cc1313',
            backgroundColor: 'rgba(204, 19, 19, 0.1)',
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: true }
        }
    }
});

// Gr√°fico de Motivos
const ctxMotivos = document.getElementById('chartMotivos').getContext('2d');
new Chart(ctxMotivos, {
    type: 'bar',
    data: {
        labels: {{ datos_motivos.labels|tojson }},
        datasets: [{
            label: 'Frecuencia',
            data: {{ datos_motivos.data|tojson }},
            backgroundColor: '#cc1313'
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        }
    }
});
</script>
{% endif %}

<style>
.profile-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.student-card {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.student-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
}

.student-avatar {
    font-size: 60px;
    background: #f0f0f0;
    border-radius: 50%;
    width: 100px;
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.student-info h2 {
    margin: 0 0 10px 0;
    color: #cc1313;
}

.student-info p {
    margin: 5px 0;
    color: #666;
}

.student-actions {
    display: flex;
    gap: 10px;
}

.btn-edit, .btn-pdf, .btn-back {
    padding: 10px 20px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s;
}

.btn-edit {
    background: #ff9800;
    color: white;
}

.btn-pdf {
    background: #cc1313;
    color: white;
}

.btn-back {
    background: #6c757d;
    color: white;
}

.stats-section, .alerts-section, .charts-section, .history-section {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.stat-box {
    text-align: center;
    padding: 20px;
    background: #f9f9f9;
    border-radius: 10px;
}

.stat-value {
    display: block;
    font-size: 36px;
    font-weight: 700;
    color: #cc1313;
}

.stat-label {
    display: block;
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.alert {
    padding: 15px;
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    border-radius: 5px;
    margin-bottom: 10px;
}

.charts-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 30px;
}

.chart-container {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 10px;
}

.cuatrimestre-block {
    margin-bottom: 30px;
}

.cuatrimestre-block h4 {
    color: #cc1313;
    margin-bottom: 15px;
}

.no-data {
    text-align: center;
    padding: 50px;
    color: #999;
}
</style>
{% endblock %}
